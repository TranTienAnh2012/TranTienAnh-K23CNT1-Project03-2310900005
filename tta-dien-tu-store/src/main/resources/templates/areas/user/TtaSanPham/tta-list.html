<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">

<head th:replace="~{layout/tta-user-layout :: head}">
    <title>Sản phẩm</title>
</head>

<body th:replace="~{layout/tta-user-layout :: layout(~{::content})}">
    <th:block th:fragment="head-extra">
        <link rel="stylesheet" th:href="@{/css/tta-banner.css}">
    </th:block>

    <div th:fragment="content">
        <!-- Sidebar Toggle Button (Desktop) -->

        <!-- Banner Dynamic / Slider -->
        <div class="banner-wrapper animate-fade-in">
            <!-- Case 1: Multiple Banners (Carousel) - Rendered when bannerList is present (All Products) -->
            <div th:if="${bannerList != null and !bannerList.empty}" id="bannerCarousel" class="carousel slide"
                data-bs-ride="carousel">
                <div class="carousel-indicators">
                    <button type="button" data-bs-target="#bannerCarousel" th:each="banner, iterStat : ${bannerList}"
                        th:data-bs-slide-to="${iterStat.index}" th:classappend="${iterStat.first} ? 'active'"
                        th:aria-current="${iterStat.first} ? 'true'"
                        th:aria-label="'Slide ' + ${iterStat.count}"></button>
                </div>
                <div class="carousel-inner">
                    <div class="carousel-item" th:each="banner, iterStat : ${bannerList}"
                        th:classappend="${iterStat.first} ? 'active'">
                        <img th:src="@{'/uploads/' + ${banner.ttaHinhAnh}}" class="d-block w-100"
                            th:alt="${banner.ttaTenBanner}">
                        <div class="banner-overlay"
                            th:if="${banner.ttaNoiDung != null and !banner.ttaNoiDung.isEmpty()}">
                            <h5 class="banner-title" th:text="${banner.ttaTenBanner}">Title</h5>
                            <p class="banner-desc" th:text="${banner.ttaNoiDung}">Description</p>
                        </div>
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#bannerCarousel"
                    data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#bannerCarousel"
                    data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>

            <!-- Case 2: Single Banner (Category specific) - Rendered when ttaBanner is present -->
            <div th:if="${ttaBanner != null}" class="single-banner-container">
                <img th:src="@{'/uploads/' + ${ttaBanner.ttaHinhAnh}}" class="single-banner-img"
                    th:alt="${ttaBanner.ttaTenBanner}">
                <div class="banner-overlay" th:if="${ttaBanner.ttaNoiDung != null and !ttaBanner.ttaNoiDung.isEmpty()}">
                    <h3 class="banner-title h5 mb-1" th:text="${ttaBanner.ttaTenBanner}">Banner Title</h3>
                    <p class="banner-desc mb-0 small" th:text="${ttaBanner.ttaNoiDung}">Description</p>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <button class="btn btn-outline-primary btn-sm" id="sidebarToggle" onclick="toggleSidebar()">
                <i class="bi bi-funnel" id="toggleIcon"></i>
                <span id="toggleText">Ẩn bộ lọc</span>
            </button>
        </div>

        <!-- Search Results Indicator -->
        <div class="alert alert-info d-flex justify-content-between align-items-center"
            th:if="${keyword != null && !keyword.isEmpty()}">
            <div>
                <i class="bi bi-search"></i>
                <strong>Kết quả tìm kiếm cho:</strong> "<span th:text="${keyword}"></span>"
                <span class="badge bg-primary ms-2" th:text="${ttaSanPhams.size()} + ' sản phẩm'"></span>
            </div>
            <a th:href="@{/user/san-pham}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Xóa tìm kiếm
            </a>
        </div>

        <div class="row" id="mainContainer">
            <!-- Sidebar Filter -->
            <div class="col-lg-3 mb-4" id="sidebarColumn">
                <div class="card border-0 shadow-sm">
                    <div
                        class="card-header bg-white border-bottom d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-funnel"></i> Bộ lọc</h5>
                        <button class="btn btn-outline-secondary btn-sm d-lg-none" type="button"
                            data-bs-toggle="collapse" data-bs-target="#filterSidebar" aria-expanded="true"
                            aria-controls="filterSidebar">
                            <i class="bi bi-list"></i>
                        </button>
                    </div>
                    <div class="collapse show d-lg-block" id="filterSidebar">
                        <div class="card-body">
                            <!-- Category Filter -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-3" data-bs-toggle="collapse" data-bs-target="#categoryCollapse"
                                    style="cursor: pointer;" aria-expanded="true">
                                    Danh mục <i class="bi bi-chevron-down float-end"></i>
                                </h6>
                                <div class="collapse show" id="categoryCollapse">
                                    <div class="list-group list-group-flush">
                                        <a th:href="@{/user/san-pham}"
                                            class="list-group-item list-group-item-action border-0 px-0"
                                            th:classappend="${activeCategoryId == null} ? 'text-primary fw-bold' : ''">
                                            <i class="bi bi-grid me-2"></i> Tất cả sản phẩm
                                        </a>
                                        <a th:each="ttaDm : ${ttaDanhMucs}"
                                            th:href="@{/user/san-pham(categoryId=${ttaDm.ttaMaDanhMuc}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                                            class="list-group-item list-group-item-action border-0 px-0"
                                            th:classappend="${activeCategoryId == ttaDm.ttaMaDanhMuc} ? 'text-primary fw-bold' : ''">
                                            <i class="bi bi-chevron-right me-2" style="font-size: 0.8rem;"></i>
                                            <span th:text="${ttaDm.ttaTenDanhMuc}">Danh mục</span>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-3">

                            <!-- Price Filter -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-3" data-bs-toggle="collapse" data-bs-target="#priceCollapse"
                                    style="cursor: pointer;" aria-expanded="true">
                                    Khoảng giá <i class="bi bi-chevron-down float-end"></i>
                                </h6>
                                <div class="collapse show" id="priceCollapse">
                                    <form th:action="@{/user/san-pham}" method="get">
                                        <input type="hidden" name="categoryId" th:value="${activeCategoryId}"
                                            th:if="${activeCategoryId != null}">

                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Từ (VNĐ)</label>
                                            <input type="number" name="minPrice" class="form-control form-control-sm"
                                                th:value="${minPrice}" placeholder="0">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label small text-muted">Đến (VNĐ)</label>
                                            <input type="number" name="maxPrice" class="form-control form-control-sm"
                                                th:value="${maxPrice}" placeholder="Tối đa">
                                        </div>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="bi bi-filter"></i> Áp dụng
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Recently Viewed Products Section (Collapsible) -->
                            <div th:if="${recentlyViewedProducts != null and !recentlyViewedProducts.isEmpty()}">
                                <hr class="my-3">
                                <div class="mb-2">
                                    <h6 class="fw-bold mb-0" data-bs-toggle="collapse"
                                        data-bs-target="#recentlyViewedCollapse" style="cursor: pointer;"
                                        aria-expanded="true">
                                        <i class="bi bi-clock-history text-primary"></i> Đã xem
                                        <i class="bi bi-chevron-down float-end"></i>
                                    </h6>
                                    <div class="collapse show" id="recentlyViewedCollapse">
                                        <div class="recently-viewed-list mt-3">
                                            <a th:each="product : ${recentlyViewedProducts}"
                                                th:href="@{/user/san-pham/{id}(id=${product.ttaMaSanPham})}"
                                                class="d-flex align-items-center text-decoration-none mb-3 recently-viewed-item">
                                                <img th:src="@{'/uploads/' + ${product.ttaHinhAnh}}" alt="Product"
                                                    class="rounded"
                                                    style="width: 60px; height: 60px; object-fit: cover;">
                                                <div class="ms-2 flex-grow-1">
                                                    <p class="mb-0 small text-dark fw-medium text-truncate"
                                                        th:text="${product.ttaTenSanPham}" style="max-width: 150px;">
                                                        Product Name
                                                    </p>
                                                    <div
                                                        th:replace="~{layout/fragments/tta-price-display :: price-compact(${product})}">
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                        <a th:href="@{/user/recently-viewed}"
                                            class="btn btn-sm btn-outline-primary w-100 mt-2">
                                            <i class="bi bi-arrow-right"></i> Xem tất cả
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Grid -->
            <div class="col-lg-9" id="productColumn">
                <div class="row mb-4" id="productListGrid">
                    <div class="col-6 col-md-4 col-lg-3 mb-3 animate-fade-in product-item"
                        th:each="ttaSp, iterStat : ${ttaSanPhams}" th:attr="data-index=${iterStat.index}"
                        th:style="${iterStat.index >= 12} ? 'display: none;' : ''">
                        <div class="product-card position-relative h-100">
                            <span class="badge-installment">Trả góp 0%</span>
                            <a th:href="@{'/user/san-pham/' + ${ttaSp.ttaMaSanPham}}" class="text-decoration-none">
                                <img th:src="@{'/uploads/' + ${ttaSp.ttaHinhAnh}}" class="card-img-top"
                                    alt="Product Image" style="height: 180px; object-fit: contain;">
                            </a>
                            <div class="card-body p-2 d-flex flex-column">
                                <a th:href="@{'/user/san-pham/' + ${ttaSp.ttaMaSanPham}}" class="text-decoration-none">
                                    <h6 class="product-name" th:text="${ttaSp.ttaTenSanPham}">Tên sản phẩm</h6>
                                </a>
                                <div class="mt-auto">
                                    <!-- Price Display with Discount -->
                                    <div th:replace="~{layout/fragments/tta-price-display :: price-compact(${ttaSp})}">
                                    </div>
                                    <div class="product-rating mb-2"
                                        th:attr="data-rating=${productRatings.get(ttaSp.ttaMaSanPham) ?: 0}">
                                        <!-- Stars will be rendered by JavaScript -->
                                        <span class="stars-container"></span>
                                        <span class="text-muted ms-1" style="font-size: 0.7rem;"
                                            th:text="'(' + ${productReviewCounts.get(ttaSp.ttaMaSanPham) ?: 0} + ')'">
                                            (0)
                                        </span>
                                    </div>
                                    <a th:href="@{'/user/cart/add/' + ${ttaSp.ttaMaSanPham}}"
                                        class="btn btn-outline-danger btn-sm w-100 rounded-pill">
                                        <i class="bi bi-cart-plus"></i> Thêm vào giỏ
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- No products found message -->
                    <div class="col-12 text-center py-5" th:if="${ttaSanPhams.empty}">
                        <i class="bi bi-search display-1 text-muted"></i>
                        <p class="mt-3 text-muted">Không tìm thấy sản phẩm nào phù hợp.</p>
                        <a th:href="@{/user/san-pham}" class="btn btn-outline-primary">Xem tất cả sản phẩm</a>
                    </div>
                </div>

                <!-- Nút Xem thêm -->
                <div class="text-center mb-5" id="showMoreContainer" th:if="${ttaSanPhams.size() > 12}">
                    <button class="btn btn-outline-primary btn-lg" id="showMoreBtn" onclick="showMoreProducts()">
                        <i class="bi bi-chevron-down"></i> Xem thêm sản phẩm
                    </button>
                </div>
            </div>
        </div>

        <script>
            let sidebarVisible = true;

            function toggleSidebar() {
                const sidebar = document.getElementById('sidebarColumn');
                const productColumn = document.getElementById('productColumn');
                const toggleText = document.getElementById('toggleText');
                const toggleIcon = document.getElementById('toggleIcon');
                const productItems = document.querySelectorAll('.product-item');

                sidebarVisible = !sidebarVisible;

                if (sidebarVisible) {
                    // Show sidebar
                    sidebar.style.display = 'block';
                    productColumn.classList.remove('col-lg-12');
                    productColumn.classList.add('col-lg-9');
                    toggleText.textContent = 'Ẩn bộ lọc';
                    toggleIcon.className = 'bi bi-funnel';

                    // Reset product columns to 4 per row (col-lg-3)
                    productItems.forEach(item => {
                        item.classList.remove('col-lg-2');
                        item.classList.add('col-lg-3');
                    });
                } else {
                    // Hide sidebar
                    sidebar.style.display = 'none';
                    productColumn.classList.remove('col-lg-9');
                    productColumn.classList.add('col-lg-12');
                    toggleText.textContent = 'Hiện bộ lọc';
                    toggleIcon.className = 'bi bi-funnel-fill';

                    // Change product columns to 6 per row (col-lg-2)
                    productItems.forEach(item => {
                        item.classList.remove('col-lg-3');
                        item.classList.add('col-lg-2');
                    });
                }
            }

            function showMoreProducts() {
                // Hiển thị tất cả sản phẩm
                const allProducts = document.querySelectorAll('.product-item');
                allProducts.forEach(product => {
                    product.style.display = '';
                });

                // Ẩn nút "Xem thêm"
                document.getElementById('showMoreContainer').style.display = 'none';
            }

            // Render star ratings
            function renderStars() {
                document.querySelectorAll('.product-rating').forEach(ratingDiv => {
                    const rating = parseFloat(ratingDiv.getAttribute('data-rating')) || 0;
                    const container = ratingDiv.querySelector('.stars-container');

                    let starsHTML = '';
                    const fullStars = Math.floor(rating);
                    const hasHalfStar = (rating - fullStars) >= 0.5;

                    // Full stars
                    for (let i = 0; i < fullStars; i++) {
                        starsHTML += '<i class="bi bi-star-fill"></i>';
                    }

                    // Half star
                    if (hasHalfStar) {
                        starsHTML += '<i class="bi bi-star-half"></i>';
                    }

                    // Empty stars
                    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                    for (let i = 0; i < emptyStars; i++) {
                        starsHTML += '<i class="bi bi-star"></i>';
                    }

                    container.innerHTML = starsHTML;
                });
            }

            // Run on page load
            document.addEventListener('DOMContentLoaded', function () {
                renderStars();
                initializeCollapseStates();
            });

            // Initialize collapse states from localStorage
            function initializeCollapseStates() {
                const collapseElements = [
                    { id: 'categoryCollapse', key: 'categoryCollapseState' },
                    { id: 'priceCollapse', key: 'priceCollapseState' },
                    { id: 'recentlyViewedCollapse', key: 'recentlyViewedCollapseState' }
                ];

                collapseElements.forEach(({ id, key }) => {
                    const element = document.getElementById(id);
                    if (!element) return;

                    // Get saved state from localStorage (default to 'show' if not set)
                    const savedState = localStorage.getItem(key);

                    // Apply saved state
                    if (savedState === 'hidden') {
                        element.classList.remove('show');
                    } else if (savedState === 'show') {
                        element.classList.add('show');
                    }

                    // Listen for collapse/expand events and save to localStorage
                    element.addEventListener('show.bs.collapse', function () {
                        localStorage.setItem(key, 'show');
                    });

                    element.addEventListener('hide.bs.collapse', function () {
                        localStorage.setItem(key, 'hidden');
                    });
                });
            }
        </script>

        <style>
            .recently-viewed-item {
                transition: all 0.2s ease;
                padding: 8px;
                border-radius: 8px;
            }

            .recently-viewed-item:hover {
                background-color: #f8f9fa;
                transform: translateX(5px);
            }
        </style>
    </div>
</body>

</html>